---
layout: post
title: "request 对象"
date: 2018-05-01
tag: thinkPHP5
---

### 一、如何获取当前的请求信息

*ThinkPHP5 的 Request 对象由 think\Request 类完成*

Request 对象的一个主要职责是统一和更安全地获取当前的请求信息， 你需要避免直接操作 $_GET 、$_POST 、 $_REQUEST 、 $_SESSION 、 $_COOKIE ， 甚至 $_FILES 等全局变量， 而是统一使用
Request 对象提供的方法来获取请求变量

**传统方式调用**

该用法主要是用来告诉大家 Request 对象是如何实例化的， 因为实际开发中很少选择这种方式调用

```
<?php
namespace app\index\controller;

use think\Request;

class Index
{
  public function hello($name = 'world')
  {
    $request = Request::instance();
    echo 'url:'.$request->url().'<br/>';
    return 'Hello,'.$name.'!';
  }
}
```

**继承think\Controller**

如果控制器类继承了 think\Controller 的话， 可以做如下简化调用

```
<?php
namespace app\index\controller;

use think\Controller;

class Index extends Controller
{
  public function hello($name = 'world')
  {
    echo 'url:'.$this->request->url().'<br/>';
    return 'hello,'.$name.'!';
  }
}
```

**自动注入请求对象[ !!! ]**

如果没有继承 think\Controller ， 则可以使用 Request 对象注入的方式来简化调用

```
<?php
namespace app\index\controller;

use think\Request;

class Index
{
  public function hello(Request $request,$name = 'world')
  {
    echo 'url:'.$request->url().'<br/>';
    return 'hello,'.$name.'!';
  }
}
提示：
hello方法的request参数是系统自动注入的 不需要通过url请求传入
```

**动态绑定属性**

可以给Request请求对象绑定属性， 方便全局调用， 例如我们可以在公共控制器中 *绑定当前登录的用户模型* 到请求对象

```
<?php
namespace app\index\controller;

use app\index\model\User;
use think\Controller;
use think\Request;
use think\Session;

class Base extends Controller
{
  public function _initialize()
  {
    $user = User::get(Session::get('user_id'));
    Request::instance()->bind('user',$user);
  }
}
在其他控制器中直接使用
<?php
namespace app\index\controller;

use app\index\controller\Base;
use think\Request;

class Index extends Base
{
  public function index(Request $request)
  {
    echo $request->user->id;
    echo $request->user->name;
  }
}
```

**使用助手函数**

如果既没有继承 think\Controller 也不想给操作方法添加额外的 Request 对象参数， 那么也可以使用
系统提供的助手

```
<?php
namespace app\index\controller;
class Index
{
  public function hello($name = 'world')
  {
    echo 'url:'.request()->url().'<br/>';
    return 'hello,'.$name.'!';
  }
}
```

上面任意一种方式都可以调用当前请求的 Request 对象实例， 然后通过请求对象实例的方法来完成不同的信息获取或者设置

### 二、请求信息 [ 请求对象的常用方法 ]

**获取请求变量**

系统推荐使用 param 方法统一获取当前请求变量， 该方法最大的优势是让你不需要区分当前请求类型而使用
不同的全局变量或者方法， 并且可以满足大部分的参数需求

```
<?php
namespace app\index\controller;

use think\Request;

class Index
{
    public function hello (Request $request)
    {
      echo '请求对象：';
      dump($request->param());
      echo 'name:'.$request->param('name');
    }
}

```

系统提供了一个 *input助手函数* 来简化 Request 对象的param方法， 用法如下

```
<?php
namespace app\index\controller;
class Index
{
  public funtion hello()
  {
    echo '请求对象：';
    dump(input());
    echo 'name:'.input('name');
  }
}
```

param 方法获取的参数会自动判断当前的请求， 以 POST 请求为例的话， 参数的优先级别为：

`路由变量 > 当前请求变量（ $_POST变量） > $_GET变量`

注意：
这里的路由变量指的是路由规则里面定义的变量或者 PATH_INFO 地址中的变量。 路由变量无法使用
get 方法或者 $_GET 变量获取。

param 方法支持变量的过滤和默认值

```
<?php
namespace app\index\controller;

use think\Request;

class Index
{
  public function hello(Request $request)
  {
    echo 'name:'.$request->param('name','world','strtolower');
    echo '<br/>test:'.$request->param('test','thinkphp','strtoupper');
  }
}
thinkphp > library > think > Request.php
public function param($name = '', $default = null, $filter = '')
```

**获取请求参数**

```
namespace app\index\controller;

use think\Request;

class Index
{
  public function hello(Request $request)
  {
    echo '请求方法：'.$request->method().'<br/>';
    echo '资源类型：'.$request->type().'<br/>';
    echo '访问ip：'.$request->ip().'<br/>';
    echo '是否ajax请求：'.var_export($request->isAjax(),true).'<br/>';
    echo '请求参数：';
    dump($request->param());
    echo '请求参数：仅包含name';
    dump($request->only(['name']));
    echo '请求参：排除name';
    dump($request->except(['name']));
  }
}

localhost/index/index/hello/test/ddd.html?name=thinkphp

请求方法： GET
资源类型： html
访问地址： 127.0.0.1
是否AJax请求： false
请求参数：
array (size=2)
'test' => string 'ddd' (length=3)
'name' => string 'thinkphp' (length=8)
请求参数： 仅包含name
array (size=1)
'name' => string 'thinkphp' (length=8)
请求参数： 排除name
array (size=1)
'test' => string 'ddd' (length=3)
```

**获取URL信息**

```
<?php
namespace app\index\controller;
use think\Request;
class Index
{
  public function hello(Request $request,$name = 'World')
  {
    // 获取当前域名
    echo 'domain: ' . $request->domain() . '<br/>';
    // 获取当前入口文件
    echo '当前入口文件 file: ' . $request->baseFile() . '<br/>';
    // 获取当前URL地址 不含域名
    echo 'url: ' . $request->url() . '<br/>';
    // 获取包含域名的完整URL地址
    echo 'url with domain: ' . $request->url(true) . '<br/>';
    // 获取当前URL地址 不含QUERY_STRING
    echo 'url without query: ' . $request->baseUrl() . '<br/>';
    // 获取URL访问的ROOT地址
    echo 'root:' . $request->root() . '<br/>';
    // 获取URL访问的ROOT地址
    echo 'root with domain: ' . $request->root(true) . '<br/>';
    // 获取URL地址中的PATH_INFO信息
    echo 'pathinfo: ' . $request->pathinfo() . '<br/>';
    // 获取URL地址中的PATH_INFO信息 不含后缀
    echo 'pathinfo: ' . $request->path() . '<br/>';
    // 获取URL地址中的后缀信息
    echo 'ext: ' . $request->ext() . '<br/>';
    return 'Hello,' . $name . '！ ';
  }
}

访问下面的URL地址：
http://tp5.com/index/index/hello.html?name=thinkphp

页面输出结果为：
domain: http://tp5.com
当前入口文件 file: /index.php
url: /index/index/hello.html?name=thinkphp
url with domain: http://tp5.com/index/index/hello.html?name=thinkphp
url without query: /index/index/hello.html
root:
root with domain: http://tp5.com
pathinfo: index/index/hello.html
pathinfo: index/index/hello
ext: html
Hello,thinkphp！
```

```
URL请求和信息方法： 方法
domain     获取当前的域名
url        获取当前的完整URL地址
baseUrl    获取当前的URL地址， 不含QUERY_STRING
baseFile   获取当前的SCRIPT_NAME
root       获取当前URL的root地址
pathinfo   获取当前URL的pathinfo地址
path       获取当前URL的pathinfo地址， 不含后缀
ext        获取当前URL的后缀
type       获取当前请求的资源类型
scheme     获取当前请求的scheme
query      获取当前URL地址的QUERY_STRING
host       获取当前URL的host地址
port       获取当前URL的port号
protocol   获取当前请求的SERVER_PROTOCOL
remotePort 获取当前请求的REMOTE_PORT

url、 baseUrl、 baseFile、 root方法如果传入true， 表示获取包含域名的地址
```

**获取当前 模块 控制器 操作信息**

```
public function hello(Request $request,$name = 'world')
{
  echo '模块：'.$request->module();
  echo '<br/> 控制器：'.$request->controller();
  echo '<br/> 操作：'.$request->action();
}

访问URL地址：
http://tp5.com/index/index/hello.html?test=ddd&name=thinkphp

页面会显示：
模块： index
控制器： Index
操作： hello
```

*controller 方法获取的是驼峰命名的实际的控制器名， 其它都是小写返回*

**获取路由和调度信息**

```
<?php
namespace app\index\controller;
use think\Request;
class index
{
  public function hello(Request $request,$name = 'world')
  {
    echo '路由信息：';
    dump($request->routeInfo());
    echo '调度信息：';
    dump($request->dispatch());
    return 'hello,'.$name.'!';
  }
}
然后在配置文件中添加路由定义为：
return [
'hello/:name' =>['index/hello',[],['name'=>'\w+']],
];
访问下面的URL地址：
http://tp5.com/hello/thinkphp
页面输出信息为：
路由信息：
array (size=4)
'rule' => string 'hello/:name' (length=11)
'route' => string 'index/hello' (length=11)
'pattern' =>
array (size=1)
'name' => string '\w+' (length=3)
'option' =>
array (size=0)
empty
调度信息：
array (size=2)
'type' => string 'module' (length=6)
'module' =>
array (size=3)
0 => null
1 => string 'index' (length=5)
2 => string 'hello' (length=5)
Hello,thinkphp！
```
